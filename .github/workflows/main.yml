# Flutter Android APK è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒå·¥ä½œæµ

name: Build and Release APK

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€tagæ—¶è‡ªåŠ¨æ„å»º
  push:
    tags:
      - 'v*'
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.1.5)'
        required: false
        default: 'manual-build'

# å·¥ä½œæµä»»åŠ¡
jobs:
  build-apk:
    name: æ„å»º Android APK
    runs-on: ubuntu-latest
    
    # è¶…æ—¶è®¾ç½® (30åˆ†é’Ÿ)
    timeout-minutes: 30

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Java ç¯å¢ƒ
      - name: â˜• è®¾ç½® Java JDK
        uses: actions/setup-java@v4
        with: 
          distribution: 'zulu'
          java-version: '17'

      # 3. è®¾ç½® Flutter ç¯å¢ƒ
      - name: ğŸ”§ è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true
      
      # 4. éªŒè¯ Flutter å®‰è£…
      - name: ğŸ” éªŒè¯ Flutter å®‰è£…
        run: |
          flutter --version
          flutter doctor -v
      
      # 5. è·å–ä¾èµ–
      - name: ğŸ“¦ è·å–é¡¹ç›®ä¾èµ–
        run: flutter pub get
      
      # 6. è¿è¡Œä»£ç åˆ†æ (å¯é€‰)
      - name: ğŸ” è¿è¡Œä»£ç åˆ†æ
        run: flutter analyze
        continue-on-error: true
      
      # 7. è§£ç ç­¾åæ–‡ä»¶ (å¦‚æœéœ€è¦ç­¾å)
      - name: ğŸ” è§£ç ç­¾åæ–‡ä»¶
        if: ${{ secrets.KEYSTORE != '' }}
        run: |
          echo "$ENCODED_KEYSTORE" | base64 -d > android/app/keystore.jks
        env:
          ENCODED_KEYSTORE: ${{ secrets.KEYSTORE }}
      
      # 8. åˆ›å»º keystore.properties æ–‡ä»¶ (å¦‚æœéœ€è¦ç­¾å)
      - name: ğŸ“ åˆ›å»ºç­¾åé…ç½®æ–‡ä»¶
        if: ${{ secrets.KEYSTORE != '' }}
        run: |
          echo "storePassword=$KEYSTORE_PASSWORD" >> android/keystore.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/keystore.properties
          echo "keyAlias=$KEY_ALIAS" >> android/keystore.properties
          echo "storeFile=keystore.jks" >> android/keystore.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # 9. æ„å»º APK (æ ¹æ®æ˜¯å¦æœ‰ç­¾åæ–‡ä»¶å†³å®šæ„å»ºæ–¹å¼)
      - name: ğŸ”¨ æ„å»º APK
        run: |
          if [ -f "android/app/keystore.jks" ]; then
            echo "ä½¿ç”¨ç­¾åæ„å»º APK"
            flutter build apk --release --split-per-abi
          else
            echo "æ„å»ºæœªç­¾å APK"
            flutter build apk --release --split-per-abi
          fi

      # 10. åˆ—å‡ºæ„å»ºäº§ç‰©
      - name: ğŸ“‹ åˆ—å‡ºæ„å»ºäº§ç‰©
        run: |
          echo "=== APK æ„å»ºäº§ç‰© ==="
          ls -la build/app/outputs/flutter-apk/
          echo ""
          echo "=== æ–‡ä»¶å¤§å°ä¿¡æ¯ ==="
          du -h build/app/outputs/flutter-apk/*.apk
      
      # 11. é‡å‘½å APK æ–‡ä»¶ (æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯)
      - name: ğŸ·ï¸ é‡å‘½å APK æ–‡ä»¶
        run: |
          cd build/app/outputs/flutter-apk/
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=$(echo ${{ github.ref_name }} | sed 's/^v//')
          else
            VERSION="${{ github.event.inputs.version || 'manual' }}"
          fi
          
          # é‡å‘½åæ–‡ä»¶
          for file in app-*.apk; do
            if [ -f "$file" ]; then
              arch=$(echo $file | sed 's/app-//' | sed 's/-release.apk//')
              new_name="bili_you_${VERSION}_${arch}.apk"
              mv "$file" "$new_name"
              echo "é‡å‘½å: $file -> $new_name"
            fi
          done
          
          echo "=== é‡å‘½ååçš„æ–‡ä»¶ ==="
          ls -la *.apk
      
      # 12. ä¸Šä¼ æ„å»ºäº§ç‰©ä½œä¸ºå·¥ä»¶
      - name: ğŸ“¤ ä¸Šä¼  APK ä½œä¸ºå·¥ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: apk-files
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30
      
      # 13. åˆ›å»º Release (ä»…åœ¨æ¨é€ tag æ—¶)
      - name: ğŸš€ åˆ›å»º Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: ncipollo/release-action@v1
        with:
          artifacts: "build/app/outputs/flutter-apk/*.apk"
          allowUpdates: true
          draft: false
          generateReleaseNotes: true
          name: "bili_you ${{ github.ref_name }}"
          body: |
            ## ğŸ“± bili_you ${{ github.ref_name }}
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            - `bili_you_*_arm64-v8a.apk`: é€‚ç”¨äº 64 ä½ ARM è®¾å¤‡ (æ¨èï¼Œæ”¯æŒå¤§éƒ¨åˆ†ç°ä»£ Android è®¾å¤‡)
            - `bili_you_*_armeabi-v7a.apk`: é€‚ç”¨äº 32 ä½ ARM è®¾å¤‡ (å…¼å®¹è€è®¾å¤‡)
            - `bili_you_*_x86_64.apk`: é€‚ç”¨äº 64 ä½ x86 è®¾å¤‡ (æ¨¡æ‹Ÿå™¨æˆ–ç‰¹æ®Šè®¾å¤‡)
            
            ### ğŸ”§ å®‰è£…è¦æ±‚
            - Android 5.0 (API 21) åŠä»¥ä¸Šç‰ˆæœ¬
            - å»ºè®®ä¸‹è½½ arm64-v8a ç‰ˆæœ¬ä»¥è·å¾—æœ€ä½³æ€§èƒ½
            
            ### ğŸ“ æ›´æ–°å†…å®¹
            è¯¦è§ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—
          token: ${{ secrets.GITHUB_TOKEN }}

# 原生评论区调试工具使用指南

## 概述

当原生评论区无法正常加载时，可以使用内置的调试工具来诊断和解决问题。

## 使用方法

### 方法1：从设置页面访问

1. 打开应用设置
2. 进入"通用设置"
3. 在"视频"部分找到"原生评论区调试"
4. 点击进入调试页面

### 方法2：从错误页面直接访问

1. 当评论区加载失败时，会显示错误页面
2. 点击"调试"按钮
3. 系统会弹出调试选项对话框

### 方法3：快速弹窗诊断

当评论区出现问题时，系统会自动弹出诊断对话框，提供以下选项：
- **调试诊断**：打开详细的调试工具
- **切换到网页版**：临时切换到网页版评论区
- **取消**：关闭对话框

## 调试工具功能

### 自动检测项目

1. **设置检查**
   - 验证"使用原生评论区"设置是否开启
   - 如果关闭会提示如何开启

2. **BVID转换测试**
   - 测试视频ID转换是否正常
   - 验证输入的BVID格式是否正确

3. **API连接测试**
   - 测试与B站评论API的连接
   - 验证网络连接和API响应

4. **数据解析验证**
   - 检查返回的评论数据是否正常
   - 显示评论数量和示例内容

### 错误分析

调试工具会自动分析常见错误并提供解决建议：

#### -404 错误（评论区不存在）
- **原因**：视频不存在或评论区已关闭
- **解决方案**：
  - 检查视频是否正常播放
  - 尝试其他视频
  - 使用网页版评论区

#### -403 错误（访问被限制）
- **原因**：需要登录或权限不足
- **解决方案**：
  - 登录B站账号
  - 检查账号状态
  - 使用网页版评论区

#### 网络超时
- **原因**：网络连接不稳定
- **解决方案**：
  - 检查网络连接
  - 稍后重试
  - 切换网络

#### 网络连接错误
- **原因**：无法连接到服务器
- **解决方案**：
  - 检查网络连接
  - 检查DNS设置
  - 关闭VPN或代理

## 快速解决方案

### 临时解决方案
如果原生评论区持续出现问题，可以：

1. **切换到网页版评论区**
   - 设置 → 通用设置 → 视频 → 关闭"使用原生评论区"
   - 或在错误对话框中点击"切换到网页版"

2. **重试操作**
   - 点击"重试"按钮
   - 切换到其他网络
   - 重启应用

### 长期解决方案
1. **检查网络环境**
   - 确保网络连接稳定
   - 检查防火墙设置
   - 尝试关闭VPN或代理

2. **更新应用**
   - 检查是否有应用更新
   - 更新到最新版本

3. **清除缓存**
   - 清除应用缓存
   - 重启应用

## 调试结果说明

### 成功状态
当看到以下信息时，表示原生评论区工作正常：
- ✅ 设置检查通过
- ✅ BVID转换成功
- ✅ API调用成功
- 显示评论数量和示例内容

### 错误状态
当出现 ❌ 标记时，表示该步骤存在问题：
- 查看具体错误信息
- 参考错误分析部分
- 尝试建议的解决方案

## 常见问题

### Q: 调试工具显示成功，但评论区仍然不工作？
A: 可能是UI渲染问题，尝试：
- 重启应用
- 切换到其他视频再切换回来
- 清除应用缓存

### Q: 所有测试都失败？
A: 可能是网络问题，尝试：
- 检查网络连接
- 切换网络（Wi-Fi/移动数据）
- 关闭VPN或代理
- 使用网页版评论区

### Q: 只有特定视频的评论区不工作？
A: 可能是该视频的评论区有特殊限制：
- 尝试其他视频
- 检查视频是否正常播放
- 该视频可能关闭了评论功能

## 反馈问题

如果调试工具无法解决问题，请：
1. 记录调试工具的完整输出
2. 记录具体的错误信息
2. 记录出现问题的视频BVID
3. 向开发者反馈

## 技术细节

调试工具会执行以下检查：
- 设置验证：`SettingsStorageKeys.useNativeComments`
- BVID转换：`BvidAvidUtil.bvid2Av()`
- API调用：`ReplyApiV2.getComments()`
- 错误分析：基于HTTP响应码和异常类型

调试工具使用的测试参数：
- API端点：`https://api.bilibili.com/x/v2/reply`
- 请求参数：`type=1, sort=1, ps=20, pn=1`
- 超时设置：HttpUtils默认配置